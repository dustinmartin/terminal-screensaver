#!/bin/bash
# Launch screensaver - one fullscreen Alacritty per monitor

export PATH="$HOME/.local/bin:$PATH"

if ! command -v tte &>/dev/null; then
  echo "tte not found. Install: pipx install terminaltexteffects" >&2
  exit 1
fi

OS=$(uname -s)

# Use a lock file to prevent concurrent instances (kernel releases on process exit)
if [[ "$OS" == "Linux" ]]; then
  LOCK_FILE="${XDG_RUNTIME_DIR:-/tmp}/screensaver.lock"
  exec 9>"$LOCK_FILE"
  flock -n 9 || exit 0
else
  pgrep -f "[a]lacritty.*screensaver-cmd" &>/dev/null && exit 0
fi

SCRIPT_DIR="$(cd "$(dirname "$0")/.." && pwd)"
STATE_FILE=~/.local/state/screensaver/toggles/screensaver-off

if [[ -f "$STATE_FILE" ]] && [[ $1 != "force" ]]; then
  exit 1
fi

# Save and suppress notifications (Linux/GNOME only)
if [[ "$OS" == "Linux" ]]; then
  PREV_SHOW_BANNERS=$(gsettings get org.gnome.desktop.notifications show-banners 2>/dev/null)
  gsettings set org.gnome.desktop.notifications show-banners false 2>/dev/null
fi

PIDS=()

cleanup() {
  if [[ "$OS" == "Linux" ]] && [[ -n "$PREV_SHOW_BANNERS" ]]; then
    gsettings set org.gnome.desktop.notifications show-banners "$PREV_SHOW_BANNERS" 2>/dev/null
  fi
  for pid in "${PIDS[@]}"; do
    kill "$pid" 2>/dev/null
  done
}
trap cleanup EXIT

if [[ "$OS" == "Darwin" ]]; then
  MONITOR_COUNT=$(system_profiler SPDisplaysDataType | grep -c "Resolution")
else
  MONITOR_COUNT=$(xrandr --listmonitors 2>/dev/null | grep -c "^ " || echo 1)
fi

for i in $(seq 1 "$MONITOR_COUNT"); do
  if [[ "$OS" == "Darwin" ]]; then
    alacritty \
      --title "screensaver" \
      --config-file "$SCRIPT_DIR/config/alacritty-screensaver.toml" \
      -e "$SCRIPT_DIR/bin/screensaver-cmd" &
  else
    alacritty \
      --class "org.screensaver,org.screensaver" \
      --config-file "$SCRIPT_DIR/config/alacritty-screensaver.toml" \
      -e "$SCRIPT_DIR/bin/screensaver-cmd" &
  fi
  PIDS+=($!)
done

wait -n
