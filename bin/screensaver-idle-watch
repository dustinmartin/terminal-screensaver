#!/bin/bash
# Watch for idle and launch screensaver when threshold is reached
# Linux: uses Mutter's IdleMonitor (Wayland-native)
# macOS: uses IOHIDSystem idle time

TIMEOUT_MS=${SCREENSAVER_TIMEOUT_MS:-300000}  # 5 minutes default
POLL_INTERVAL=5

SCRIPT_DIR="$(cd "$(dirname "$0")/.." && pwd)"
OS=$(uname -s)

get_idle_ms() {
  if [[ "$OS" == "Darwin" ]]; then
    idle_ns=$(ioreg -c IOHIDSystem | awk '/HIDIdleTime/ {print $NF; exit}')
    echo $(( idle_ns / 1000000 ))
  else
    gdbus call --session \
      --dest org.gnome.Mutter.IdleMonitor \
      --object-path /org/gnome/Mutter/IdleMonitor/Core \
      --method org.gnome.Mutter.IdleMonitor.GetIdletime 2>/dev/null | awk '{print $2}' | tr -dc '0-9'
  fi
}

while true; do
  idle_ms=$(get_idle_ms)
  if [[ -n "$idle_ms" ]] && [[ "$idle_ms" -ge "$TIMEOUT_MS" ]]; then
    "$SCRIPT_DIR/bin/screensaver-launch"
    sleep "$POLL_INTERVAL"
  fi
  sleep "$POLL_INTERVAL"
done
