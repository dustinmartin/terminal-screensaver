#!/bin/bash
# Core screensaver loop - runs TTE effects until input detected

export PATH="$HOME/.local/bin:$PATH"

exit_screensaver() {
  printf '\e[?25h'            # Show cursor
  printf '\e[?1000l\e[?1003l' # Disable mouse tracking
  pkill -x tte 2>/dev/null
  exit 0
}

trap exit_screensaver SIGINT SIGTERM SIGHUP SIGQUIT

SCRIPT_DIR="$(cd "$(dirname "$0")/.." && pwd)"
SCREENSAVER_TXT="$SCRIPT_DIR/config/screensaver.txt"

printf '\033]11;rgb:00/00/00\007'  # Black background
printf '\e[?25l'                    # Hide cursor
printf '\e[?1000h\e[?1003h'        # Enable mouse tracking

tty=$(tty 2>/dev/null)

# Ignore input for the first 2 seconds (window creation and focus events
# generate mouse tracking data that would otherwise cause an immediate exit)
GRACE_END=$(( SECONDS + 2 ))

while true; do
  tte -i "$SCREENSAVER_TXT" \
    --frame-rate 120 --canvas-width 0 --canvas-height 0 \
    --reuse-canvas --anchor-canvas c --anchor-text c \
    --random-effect --exclude-effects dev_worm \
    --no-eol --no-restore-cursor &

  while pgrep -t "${tty#/dev/}" -x tte >/dev/null; do
    if read -n1 -t 1; then
      if (( SECONDS >= GRACE_END )); then
        exit_screensaver
      fi
    fi
  done
done
